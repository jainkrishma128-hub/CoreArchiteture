using MediatR;
using CommonArchitecture.Core.DTOs;
using CommonArchitecture.Core.Interfaces;

namespace CommonArchitecture.Application.Queries.Dashboard.GetDashboardStats;

public class GetDashboardStatsQueryHandler : IRequestHandler<GetDashboardStatsQuery, DashboardStatsDto>
{
    private readonly IUserRepository _userRepository;
    private readonly ILoggingService _loggingService;

    public GetDashboardStatsQueryHandler(IUserRepository userRepository, ILoggingService loggingService)
    {
        _userRepository = userRepository;
        _loggingService = loggingService;
    }

    public async Task<DashboardStatsDto> Handle(GetDashboardStatsQuery request, CancellationToken cancellationToken)
    {
        var to = DateTime.UtcNow;
        var from = to.AddDays(-30);

        var registrations = await _userRepository.GetDailyRegistrationsAsync(from, to);
        var (apiCalls, statusDist, avgDuration) = await _loggingService.GetDashboardStatsAsync(from, to);

        return new DashboardStatsDto
        {
            UserRegistrations = registrations,
            ApiCalls = apiCalls,
            StatusCodes = statusDist,
            AverageResponseTime = avgDuration
        };
    }
}
