using CommonArchitecture.Application.DTOs;
using CommonArchitecture.Core.Interfaces;
using MediatR;

namespace CommonArchitecture.Application.Queries.Roles.GetAllRoles;

public class GetAllRolesQueryHandler : IRequestHandler<GetAllRolesQuery, PaginatedResult<RoleDto>>
{
    private readonly IRoleRepository _roleRepository;

    public GetAllRolesQueryHandler(IRoleRepository roleRepository)
    {
        _roleRepository = roleRepository;
    }

    public async Task<PaginatedResult<RoleDto>> Handle(GetAllRolesQuery request, CancellationToken cancellationToken)
    {
        var parameters = request.Parameters;
        
        // Get paginated roles
        var roles = await _roleRepository.GetPagedAsync(
            parameters.SearchTerm,
            parameters.SortBy,
            parameters.SortOrder,
            parameters.PageNumber,
            parameters.PageSize);
        
        // Get total count for pagination metadata
        var totalCount = await _roleRepository.GetTotalCountAsync(parameters.SearchTerm);
        
        // Map to DTOs
        var roleDtos = roles.Select(r => new RoleDto
        {
            Id = r.Id,
            RoleName = r.RoleName
        });
        
        return new PaginatedResult<RoleDto>
        {
            Items = roleDtos,
            TotalCount = totalCount,
            PageNumber = parameters.PageNumber,
            PageSize = parameters.PageSize
        };
    }
}

