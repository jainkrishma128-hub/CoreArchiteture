using CommonArchitecture.Infrastructure.Persistence;
using FluentValidation;
using Microsoft.AspNetCore.CookiePolicy;
using Microsoft.EntityFrameworkCore;
using NToastNotify;
using CommonArchitecture.Web.Services;
using CommonArchitecture.Web.Handlers;
using CommonArchitecture.Core.Interfaces;
using CommonArchitecture.Infrastructure.Services;
using CommonArchitecture.Web.Middlewares;
using Hangfire;
using Hangfire.SqlServer;
using Hangfire.Dashboard;

var builder = WebApplication.CreateBuilder(args);

// Add services to the container.
builder.Services.AddDbContext<ApplicationDbContext>(options =>
 options.UseSqlServer(builder.Configuration.GetConnectionString("DefaultConnection")));

// Cookie policy configuration for secure token storage
builder.Services.Configure<CookiePolicyOptions>(options =>
{
 options.HttpOnly = HttpOnlyPolicy.Always;
 options.Secure = CookieSecurePolicy.SameAsRequest; // Use SameAsRequest for development, Always for production
 options.MinimumSameSitePolicy = SameSiteMode.Strict;
});

// Add Memory Cache for token storage
builder.Services.AddMemoryCache();

// Add Session support (for user display info in Admin area)
builder.Services.AddDistributedMemoryCache();
builder.Services.AddSession(options =>
{
 options.IdleTimeout = TimeSpan.FromMinutes(30);
 options.Cookie.HttpOnly = true;
 options.Cookie.IsEssential = true;
 options.Cookie.SecurePolicy = CookieSecurePolicy.SameAsRequest;
 options.Cookie.SameSite = SameSiteMode.Strict;
});

// Add HttpContextAccessor for token storage
builder.Services.AddHttpContextAccessor();

// Register RefreshTokenHandler
builder.Services.AddTransient<RefreshTokenHandler>();

// Register Token Storage Service
builder.Services.AddScoped<CommonArchitecture.Web.Services.ITokenStorageService, CommonArchitecture.Web.Services.TokenStorageService>();

// Register AuthApiService first (without handler, as it's used by the handler)
builder.Services.AddHttpClient<CommonArchitecture.Web.Services.IAuthApiService, CommonArchitecture.Web.Services.AuthApiService>(client =>
{
 client.BaseAddress = new Uri(builder.Configuration["ApiSettings:BaseUrl"] ?? "http://localhost:5089");
 client.DefaultRequestHeaders.Add("Accept", "application/json");
});

// Register HttpClient with RefreshTokenHandler for API communication
builder.Services.AddHttpClient<CommonArchitecture.Web.Services.IProductApiService, CommonArchitecture.Web.Services.ProductApiService>(client =>
{
 client.BaseAddress = new Uri(builder.Configuration["ApiSettings:BaseUrl"] ?? "http://localhost:5089");
 client.DefaultRequestHeaders.Add("Accept", "application/json");
})
.AddHttpMessageHandler<RefreshTokenHandler>();

builder.Services.AddHttpClient<CommonArchitecture.Web.Services.IRoleApiService, CommonArchitecture.Web.Services.RoleApiService>(client =>
{
 client.BaseAddress = new Uri(builder.Configuration["ApiSettings:BaseUrl"] ?? "http://localhost:5089");
 client.DefaultRequestHeaders.Add("Accept", "application/json");
})
.AddHttpMessageHandler<RefreshTokenHandler>();

builder.Services.AddHttpClient<CommonArchitecture.Web.Services.IUserApiService, CommonArchitecture.Web.Services.UserApiService>(client =>
{
 client.BaseAddress = new Uri(builder.Configuration["ApiSettings:BaseUrl"] ?? "http://localhost:5089");
 client.DefaultRequestHeaders.Add("Accept", "application/json");
})
.AddHttpMessageHandler<RefreshTokenHandler>();

builder.Services.AddHttpClient<CommonArchitecture.Web.Services.ILogApiService, CommonArchitecture.Web.Services.LogApiService>(client =>
{
    client.BaseAddress = new Uri(builder.Configuration["ApiSettings:BaseUrl"] ?? "http://localhost:5089");
    client.DefaultRequestHeaders.Add("Accept", "application/json");
})
.AddHttpMessageHandler<RefreshTokenHandler>();

builder.Services.AddHttpClient<IMenuApiService, MenuApiService>(client =>
{
 client.BaseAddress = new Uri(builder.Configuration["ApiSettings:BaseUrl"] ?? "http://localhost:5089");
 client.DefaultRequestHeaders.Add("Accept", "application/json");
})
.AddHttpMessageHandler<RefreshTokenHandler>();

builder.Services.AddHttpClient<IRoleMenuApiService, RoleMenuApiService>(client =>
{
 client.BaseAddress = new Uri(builder.Configuration["ApiSettings:BaseUrl"] ?? "http://localhost:5089");
 client.DefaultRequestHeaders.Add("Accept", "application/json");
})
.AddHttpMessageHandler<RefreshTokenHandler>();

builder.Services.AddHttpClient<IDashboardApiService, DashboardApiService>(client =>
{
 client.BaseAddress = new Uri(builder.Configuration["ApiSettings:BaseUrl"] ?? "http://localhost:5089");
 client.DefaultRequestHeaders.Add("Accept", "application/json");
})
.AddHttpMessageHandler<RefreshTokenHandler>();

// Register JwtTokenHandler (kept for compatibility if used elsewhere)
builder.Services.AddTransient<CommonArchitecture.Web.Services.JwtTokenHandler>();

// Register Logging service
builder.Services.AddScoped<ILoggingService, LoggingService>();

// Register UnitOfWork
builder.Services.AddScoped<CommonArchitecture.Core.Interfaces.IUnitOfWork, CommonArchitecture.Infrastructure.UnitOfWork.UnitOfWork>();

// Register application services used directly by Web (if any)
builder.Services.AddScoped<CommonArchitecture.Application.Services.IMenuService, CommonArchitecture.Application.Services.MenuService>();

// Configure Hangfire (same database as API - for dashboard access)
builder.Services.AddHangfire(configuration => configuration
 .SetDataCompatibilityLevel(CompatibilityLevel.Version_180)
 .UseSimpleAssemblyNameTypeSerializer()
 .UseRecommendedSerializerSettings()
 .UseSqlServerStorage(builder.Configuration.GetConnectionString("DefaultConnection"), new SqlServerStorageOptions
 {
     CommandBatchMaxTimeout = TimeSpan.FromMinutes(5),
     SlidingInvisibilityTimeout = TimeSpan.FromMinutes(5),
     QueuePollInterval = TimeSpan.Zero,
     UseRecommendedIsolationLevel = true,
     DisableGlobalLocks = true
 }));

// Register DbSeeder
builder.Services.AddScoped<DbSeeder>();

// Register FluentValidation
builder.Services.AddValidatorsFromAssemblies(AppDomain.CurrentDomain.GetAssemblies());

// Register NToastNotify with ControllersWithViews
builder.Services.AddControllersWithViews().AddNToastNotifyNoty(new NotyOptions
{
 ProgressBar = true,
 Timeout =5000,
 Theme = "metroui"
});


var app = builder.Build();

// Configure the HTTP request pipeline.
if (!app.Environment.IsDevelopment())
{
    app.UseExceptionHandler("/Error");
    // The default HSTS value is 30 days. You may want to change this for production scenarios, see https://aka.ms/aspnetcore-hsts.
    app.UseHsts();
}

// Handle status codes (e.g. 404) for non-exception errors
app.UseStatusCodePagesWithReExecute("/Error/{0}");

app.UseHttpsRedirection();
app.UseStaticFiles();

// Use Cookie Policy middleware
app.UseCookiePolicy();

// Use Session middleware (must be before UseAuthorization)
app.UseSession();

// Web exception logging middleware - must be after session so we can access it
app.UseMiddleware<WebExceptionLoggingMiddleware>();

app.UseAuthorization();

// Add NToastNotify middleware
app.UseNToastNotify();

app.MapStaticAssets();

// Configure Hangfire Dashboard (Admin only - requires authentication)
app.MapHangfireDashboard("/Admin/Hangfire", new DashboardOptions
{
    DashboardTitle = "Hangfire Jobs Dashboard",
    Authorization = new[] { new CommonArchitecture.Web.Filters.HangfireAuthorizationFilter() }
});

// Area routing (must be before default route)
app.MapControllerRoute(
 name: "areas",
 pattern: "{area:exists}/{controller=Home}/{action=Index}/{id?}");

// Default route - Home/Index as default landing page
app.MapControllerRoute(
 name: "default",
 pattern: "{controller=Home}/{action=Index}/{id?}")
 .WithStaticAssets();

// Seed Database
using (var scope = app.Services.CreateScope())
{
    var seeder = scope.ServiceProvider.GetRequiredService<DbSeeder>();
    await seeder.SeedAsync();
}

app.Run();
