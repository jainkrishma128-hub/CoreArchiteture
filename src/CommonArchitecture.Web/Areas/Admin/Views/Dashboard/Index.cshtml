@{
    ViewData["Title"] = "Dashboard";
}

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <div class="welcome-card">
                <div class="welcome-content">
                    <h2>Welcome to Admin Panel</h2>
                    <p class="text-muted">Manage your products, users, and roles from this central dashboard.</p>
                </div>
                <div class="welcome-icon">
                    <i class="bi bi-shield-lock-fill"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <!-- Revenue Chart -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm rounded-4 h-100">
                <div class="card-header bg-transparent border-bottom-0 pt-4 px-4">
                    <h5 class="fw-bold mb-0">Daily Sales Trends</h5>
                    <small class="text-muted">Last 30 days orders performance</small>
                </div>
                <div class="card-body p-4">
                    <div style="position: relative; height: 400px; width: 100%;">
                        <canvas id="revenueChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats & Top Products Sidebar -->
        <div class="col-lg-4">
            <div class="row g-4 mb-4">
                <div class="col-12">
                    <div class="stat-card stat-card-warning mb-0">
                        <div class="stat-card-body">
                            <div class="stat-icon">
                                <i class="bi bi-exclamation-triangle"></i>
                            </div>
                            <div class="stat-content">
                                <h3 class="stat-value" id="lowStockCount">--</h3>
                                <p class="stat-label">Low Stock items</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-12">
                    <div class="card border-0 shadow-sm rounded-4 h-100">
                        <div class="card-header bg-transparent border-bottom-0 pt-4 px-4">
                            <h5 class="fw-bold mb-0">Top Products</h5>
                        </div>
                        <div class="card-body px-4 pb-4">
                            <div id="topProductsList">
                                <!-- Populated via JS -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Quick Actions & Info -->
    <div class="row g-4">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm rounded-4">
                <div class="card-header bg-white pt-4 px-4 border-bottom-0">
                    <h5 class="card-title mb-0"><i class="bi bi-lightning"></i> Quick Actions</h5>
                </div>
                <div class="card-body p-4">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <a asp-area="Admin" asp-controller="Products" asp-action="Index" class="quick-action-btn">
                                <i class="bi bi-plus-circle"></i>
                                <span>Add Product</span>
                            </a>
                        </div>
                        <div class="col-md-4">
                            <a asp-area="Admin" asp-controller="Users" asp-action="Index" class="quick-action-btn">
                                <i class="bi bi-person-plus"></i>
                                <span>Add User</span>
                            </a>
                        </div>
                        <div class="col-md-4">
                            <a asp-area="Admin" asp-controller="Roles" asp-action="Index" class="quick-action-btn">
                                <i class="bi bi-shield-plus"></i>
                                <span>Add Role</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm rounded-4">
                <div class="card-header pt-4 px-4 border-bottom-0">
                    <h5 class="card-title mb-0"><i class="bi bi-info-circle"></i> System Info</h5>
                </div>
                <div class="card-body p-4">
                    <ul class="list-unstyled mb-0">
                        <li class="d-flex justify-content-between py-2 border-bottom">
                            <span class="text-muted">Application</span>
                            <strong>Common Architecture</strong>
                        </li>
                        <li class="d-flex justify-content-between py-2 border-bottom">
                            <span class="text-muted">Version</span>
                            <strong>1.0.0</strong>
                        </li>
                        <li class="d-flex justify-content-between py-2">
                            <span class="text-muted">Environment</span>
                            <strong class="text-success">Development</strong>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Chart.js Dark Theme Defaults
        Chart.defaults.color = '#cbd5e1'; 
        Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.1)';

        $(document).ready(function() {
            // Load Basic Counts
            loadBasicStats();
            // Load Analytics Charts 
            loadAnalytics();
        });



        function loadBasicStats() {
            // Existing counts if still needed, but consolidated stats is better
            $.get('/Admin/Users/GetAll?PageSize=1', function(response) {
                if (response.success && response.data) $('#usersCount').text(response.data.totalCount || 0);
            });
        }

        function loadAnalytics() {
            $.get('/Admin/Dashboard/GetStats', function(response) {
                if (response.success && response.data) {
                    const stats = response.data;
                    
                    // Update Stats Cards
                    $('#revenueCount').text(formatCurrency(stats.totalRevenue));
                    $('#ordersCount').text(stats.recentOrdersCount);
                    $('#lowStockCount').text(stats.lowStockCount);

                    // Render Charts
                    if (stats.userRegistrations) renderUserChart(stats.userRegistrations);
                    if (stats.revenueTrends) renderRevenueChart(stats.revenueTrends);

                    // Render New Sections
                    if (stats.recentOrders) renderRecentOrders(stats.recentOrders);
                    if (stats.topSellingProducts) renderTopProducts(stats.topSellingProducts);
                }
            });
        }

        function renderRecentOrders(orders) {
            const $tbody = $('#recentOrdersTable');
            $tbody.empty();

            if (!orders || orders.length === 0) {
                $tbody.append('<tr><td colspan="5" class="text-center py-4 text-muted">No recent orders found</td></tr>');
                return;
            }

            orders.forEach(order => {
                const statusBadge = getStatusBadge(order.status);
                const row = `
                    <tr>
                        <td class="ps-4"><strong>#${order.orderNumber}</strong></td>
                        <td>${order.customerName}</td>
                        <td>${formatCurrency(order.totalAmount)}</td>
                        <td>${statusBadge}</td>
                        <td class="pe-4 text-end text-muted small">${new Date(order.orderDate).toLocaleDateString()}</td>
                    </tr>
                `;
                $tbody.append(row);
            });
        }

        function renderTopProducts(products) {
            const $container = $('#topProductsList');
            $container.empty();

            if (!products || products.length === 0) {
                $container.append('<p class="text-center py-4 text-muted">No product data available</p>');
                return;
            }

            products.forEach((product, index) => {
                const item = `
                    <div class="d-flex align-items-center mb-3">
                        <div class="flex-shrink-0">
                            <div class="bg-light rounded-3 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                <span class="fw-bold text-primary small">#${index + 1}</span>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="mb-0 small fw-bold text-truncate" style="max-width: 150px;">${product.productName}</h6>
                            <small class="text-muted">${product.totalSold} sold</small>
                        </div>
                        <div class="text-end">
                            <span class="d-block fw-bold small">${formatCurrency(product.revenue)}</span>
                        </div>
                    </div>
                `;
                $container.append(item);
            });
        }

        function getStatusBadge(status) {
            const badges = {
                'Pending': '<span class="badge bg-warning-subtle text-warning border border-warning-subtle px-2">Pending</span>',
                'Processing': '<span class="badge bg-info-subtle text-info border border-info-subtle px-2">Processing</span>',
                'Shipped': '<span class="badge bg-primary-subtle text-primary border border-primary-subtle px-2">Shipped</span>',
                'Delivered': '<span class="badge bg-success-subtle text-success border border-success-subtle px-2">Delivered</span>',
                'Cancelled': '<span class="badge bg-danger-subtle text-danger border border-danger-subtle px-2">Cancelled</span>'
            };
            return badges[status] || `<span class="badge bg-secondary-subtle text-secondary border border-secondary-subtle px-2">${status}</span>`;
        }

        function renderUserChart(data) {
            const chartEl = document.getElementById('userChart');
            if (!chartEl) return;
            const ctx = chartEl.getContext('2d');
            
            // If no data, show empty state or placeholder
            const labels = (data && data.length > 0) 
                ? data.map(d => new Date(d.date).toLocaleDateString()) 
                : [new Date().toLocaleDateString()];
            const counts = (data && data.length > 0) 
                ? data.map(d => d.count) 
                : [0];

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'New Users',
                        data: counts,
                        borderColor: '#0dcaf0',
                        backgroundColor: 'rgba(13, 202, 240, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointRadius: data.length > 1 ? 0 : 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { 
                            display: true, 
                            beginAtZero: true, 
                            grid: { display: false },
                            ticks: { display: false, stepSize: 1 } 
                        },
                        x: { display: false }
                    }
                }
            });
        }

        function renderRevenueChart(data) {
            const chartEl = document.getElementById('revenueChart');
            if (!chartEl) return;
            const ctx = chartEl.getContext('2d');
            
            const labels = (data && data.length > 0) 
                ? data.map(d => new Date(d.date).toLocaleDateString()) 
                : [new Date().toLocaleDateString()];
            const amounts = (data && data.length > 0) 
                ? data.map(d => d.amount) 
                : [0];

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Amount ($)',
                            data: amounts,
                            borderColor: '#0d6efd',
                            backgroundColor: 'rgba(13, 110, 253, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Order Count',
                            data: (data && data.length > 0) ? data.map(d => d.orderCount) : [0],
                            borderColor: '#10b981',
                            backgroundColor: 'transparent',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            tension: 0.4,
                            pointRadius: 3,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: true, position: 'top', align: 'end', labels: { boxWidth: 10, font: { size: 10 } } },
                        tooltip: { mode: 'index', intersect: false }
                    },
                    scales: {
                        y: { 
                            type: 'linear',
                            display: true,
                            position: 'left',
                            beginAtZero: true, 
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            ticks: { font: { size: 10 }, callback: function(value) { return '$' + value; } }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            beginAtZero: true,
                            grid: { drawOnChartArea: false },
                            ticks: { font: { size: 10 }, stepSize: 1 }
                        },
                        x: { 
                            grid: { display: false },
                            ticks: { font: { size: 10 }, maxTicksLimit: 10 }
                        }
                    }
                }
            });
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount);
        }
    </script>
}
