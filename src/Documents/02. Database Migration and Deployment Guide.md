# Database Migration and Deployment Guide

This document provides step-by-step instructions for creating database migrations, updating databases, and deploying the application to another system with different database connection strings.

---

## Table of Contents

1. [Overview](#overview)
2. [Creating Migrations](#creating-migrations)
3. [Updating Database](#updating-database)
4. [Connection String Configuration](#connection-string-configuration)
5. [Deploying to Another System](#deploying-to-another-system)
6. [Troubleshooting](#troubleshooting)

---

## Overview

This project uses **Entity Framework Core 9.0** for database migrations. Migrations are stored in:
- `src/CommonArchitecture.Infrastructure/Migrations/`

The database context (`ApplicationDbContext`) is configured in both:
- `src/CommonArchitecture.API/Program.cs`
- `src/CommonArchitecture.Web/Program.cs`

**Important:** Both API and Web projects use the same connection string name: `DefaultConnection`

---

## Creating Migrations

### When to Create a Migration

Create a new migration when you:
- Add new entity classes
- Modify existing entity properties
- Add/remove relationships between entities
- Change entity configurations (fluent API)
- Add/remove indexes
- Modify table structures

### Step-by-Step: Create Migration

1. **Navigate to Project Root**
   ```powershell
   cd "D:\My Archi\Core"
   ```

2. **Create the Migration**
   
   **Option A: Using Web as Startup Project** (Recommended)
   ```powershell
   dotnet ef migrations add YourMigrationName -p src\CommonArchitecture.Infrastructure -s src\CommonArchitecture.Web
   ```
   
   **Option B: Using API as Startup Project**
   ```powershell
   dotnet ef migrations add YourMigrationName -p src\CommonArchitecture.Infrastructure -s src\CommonArchitecture.API
   ```

3. **Review the Generated Migration**
   - Navigate to: `src/CommonArchitecture.Infrastructure/Migrations/`
   - Find the newly created migration file (e.g., `20250101120000_YourMigrationName.cs`)
   - Review the `Up()` and `Down()` methods to ensure they are correct

4. **Example: Creating a Migration for Adding a New Field**
   ```powershell
   # After adding a new property to an entity, create migration:
   dotnet ef migrations add AddEmailToUserTable -p src\CommonArchitecture.Infrastructure -s src\CommonArchitecture.Web
   ```

---

## Updating Database

### Applying Migrations to Database

After creating a migration, apply it to your database:

1. **Navigate to Project Root**
   ```powershell
   cd "D:\My Archi\Core"
   ```

2. **Update Database**
   
   **Option A: Using Web as Startup Project**
   ```powershell
   dotnet ef database update -p src\CommonArchitecture.Infrastructure -s src\CommonArchitecture.Web
   ```
   
   **Option B: Using API as Startup Project**
   ```powershell
   dotnet ef database update -p src\CommonArchitecture.Infrastructure -s src\CommonArchitecture.API
   ```

3. **Verify Migration Applied**
   - Check the database to confirm changes are applied
   - EF Core automatically creates a `__EFMigrationsHistory` table to track applied migrations

### Updating to a Specific Migration

To rollback or move to a specific migration:

```powershell
# Rollback to a specific migration
dotnet ef database update PreviousMigrationName -p src\CommonArchitecture.Infrastructure -s src\CommonArchitecture.Web

# Rollback all migrations (removes database schema)
dotnet ef database update 0 -p src\CommonArchitecture.Infrastructure -s src\CommonArchitecture.Web
```

---

## Connection String Configuration

### Current Configuration Files

Connection strings are configured in:

1. **API Project:**
   - `src/CommonArchitecture.API/appsettings.json`
   - `src/CommonArchitecture.API/appsettings.Development.json`
   - `src/CommonArchitecture.API/appsettings.Testing.json`

2. **Web Project:**
   - `src/CommonArchitecture.Web/appsettings.json`
   - `src/CommonArchitecture.Web/appsettings.Development.json`

### Connection String Format

The connection string uses the following format:

```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Server=SERVER_NAME;Database=DATABASE_NAME;Integrated Security=True;MultipleActiveResultSets=true;TrustServerCertificate=True"
  }
}
```

### Connection String Examples

#### SQL Server Express (Windows Authentication)
```json
"DefaultConnection": "Server=DESKTOP-10Q9Q13\\SQLEXPRESS;Database=CommonArchitectureDb;Integrated Security=True;MultipleActiveResultSets=true;TrustServerCertificate=True"
```

#### SQL Server with SQL Authentication
```json
"DefaultConnection": "Server=SERVER_NAME;Database=CommonArchitectureDb;User Id=username;Password=password;MultipleActiveResultSets=true;TrustServerCertificate=True"
```

#### LocalDB (Development)
```json
"DefaultConnection": "Server=(localdb)\\mssqllocaldb;Database=CommonArchitectureDb;Trusted_Connection=True;MultipleActiveResultSets=true;TrustServerCertificate=True"
```

#### SQL Server on Remote Server
```json
"DefaultConnection": "Server=192.168.1.100,1433;Database=CommonArchitectureDb;User Id=sa;Password=YourPassword;MultipleActiveResultSets=true;TrustServerCertificate=True;Encrypt=True"
```

### Updating Connection Strings

#### Step 1: Update API Connection String

Edit `src/CommonArchitecture.API/appsettings.json`:

```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Server=NEW_SERVER_NAME;Database=CommonArchitectureDb;Integrated Security=True;MultipleActiveResultSets=true;TrustServerCertificate=True"
  }
}
```

#### Step 2: Update Web Connection String

Edit `src/CommonArchitecture.Web/appsettings.json`:

```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Server=NEW_SERVER_NAME;Database=CommonArchitectureDb;Integrated Security=True;MultipleActiveResultSets=true;TrustServerCertificate=True"
  }
}
```

**⚠️ Important:** Both API and Web must use the **same connection string** to ensure they work with the same database.

#### Step 3: Environment-Specific Configuration

For production/staging, use environment-specific files:

**Production (appsettings.Production.json):**
```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Server=PROD_SERVER;Database=CommonArchitectureDb;User Id=prod_user;Password=secure_password;MultipleActiveResultSets=true;TrustServerCertificate=True;Encrypt=True"
  }
}
```

**Using Environment Variables:**

Set environment variables (recommended for production):

**Windows PowerShell:**
```powershell
$env:ConnectionStrings__DefaultConnection="Server=PROD_SERVER;Database=CommonArchitectureDb;User Id=user;Password=pass;..."
```

**Windows CMD:**
```cmd
set ConnectionStrings__DefaultConnection=Server=PROD_SERVER;Database=CommonArchitectureDb;User Id=user;Password=pass;...
```

**Linux/macOS:**
```bash
export ConnectionStrings__DefaultConnection="Server=PROD_SERVER;Database=CommonArchitectureDb;User Id=user;Password=pass;..."
```

---

## Deploying to Another System

### Prerequisites

Before deploying to another system, ensure:

1. ✅ .NET 9.0 SDK is installed on the target system
2. ✅ SQL Server (or SQL Server Express) is installed and accessible
3. ✅ Network connectivity between application server and database server
4. ✅ Database credentials/permissions are configured

### Deployment Steps

#### Step 1: Copy Project Files

Copy the entire project to the target system, including:
- All source code files
- `src/CommonArchitecture.Infrastructure/Migrations/` folder (contains all migration files)
- `src/CommonArchitecture.API/appsettings.json`
- `src/CommonArchitecture.Web/appsettings.json`

**Or** use source control (Git) to clone the repository:
```powershell
git clone <repository-url>
cd Core
```

#### Step 2: Update Connection Strings on Target System

**Option A: Edit appsettings.json Files**

1. Edit `src/CommonArchitecture.API/appsettings.json`:
   ```json
   {
     "ConnectionStrings": {
       "DefaultConnection": "Server=TARGET_SERVER_NAME;Database=CommonArchitectureDb;User Id=username;Password=password;MultipleActiveResultSets=true;TrustServerCertificate=True"
     }
   }
   ```

2. Edit `src/CommonArchitecture.Web/appsettings.json`:
   ```json
   {
     "ConnectionStrings": {
       "DefaultConnection": "Server=TARGET_SERVER_NAME;Database=CommonArchitectureDb;User Id=username;Password=password;MultipleActiveResultSets=true;TrustServerCertificate=True"
     }
   }
   ```

**Option B: Use Environment Variables (Recommended for Production)**

Set environment variables on the target system before running the application.

#### Step 3: Restore NuGet Packages

```powershell
cd "D:\My Archi\Core"
dotnet restore
```

#### Step 4: Build the Solution

```powershell
dotnet build
```

#### Step 5: Apply Migrations to Target Database

**Important:** This step creates/updates the database schema on the target system.

1. **Navigate to Project Root**
   ```powershell
   cd "D:\My Archi\Core"
   ```

2. **Apply All Migrations**
   
   **Option A: Using Web as Startup Project**
   ```powershell
   dotnet ef database update -p src\CommonArchitecture.Infrastructure -s src\CommonArchitecture.Web
   ```
   
   **Option B: Using API as Startup Project**
   ```powershell
   dotnet ef database update -p src\CommonArchitecture.Infrastructure -s src\CommonArchitecture.API
   ```

   This command will:
   - Create the database if it doesn't exist
   - Apply all pending migrations
   - Create the `__EFMigrationsHistory` table to track applied migrations

3. **Verify Database Created/Updated**
   - Check SQL Server Management Studio (SSMS)
   - Verify all tables are created
   - Verify `__EFMigrationsHistory` table contains all migration entries

#### Step 6: Run the Application

**Start API:**
```powershell
cd src\CommonArchitecture.API
dotnet run
```

**Start Web (in another terminal):**
```powershell
cd src\CommonArchitecture.Web
dotnet run
```

### Complete Deployment Script Example

For automation, create a deployment script:

**Windows PowerShell (`deploy.ps1`):**
```powershell
# Navigate to project root
cd "D:\My Archi\Core"

# Restore packages
Write-Host "Restoring NuGet packages..." -ForegroundColor Green
dotnet restore

# Build solution
Write-Host "Building solution..." -ForegroundColor Green
dotnet build

# Apply migrations
Write-Host "Applying database migrations..." -ForegroundColor Green
dotnet ef database update -p src\CommonArchitecture.Infrastructure -s src\CommonArchitecture.Web

Write-Host "Deployment completed successfully!" -ForegroundColor Green
```

---

## Troubleshooting

### Issue: "No migrations found"

**Solution:**
- Ensure you're in the correct directory (`D:\My Archi\Core`)
- Check that migration files exist in `src/CommonArchitecture.Infrastructure/Migrations/`
- Verify the project path in the command is correct

### Issue: "Cannot open database" or Connection Error

**Solution:**
1. Verify SQL Server is running
2. Check connection string is correct
3. Verify database server name/IP is accessible
4. Check Windows Authentication or SQL Authentication credentials
5. Ensure firewall allows connections on SQL Server port (default: 1433)
6. Test connection using SQL Server Management Studio (SSMS)

### Issue: "Migration already applied" or "Migration conflicts"

**Solution:**
1. Check `__EFMigrationsHistory` table in the database
2. If migration is partially applied, you may need to:
   ```powershell
   # Remove the problematic migration from history (be careful!)
   # Then reapply
   dotnet ef database update -p src\CommonArchitecture.Infrastructure -s src\CommonArchitecture.Web
   ```

### Issue: "Both API and Web connecting to different databases"

**Solution:**
- Ensure both `appsettings.json` files have identical `DefaultConnection` strings
- Verify no environment-specific overrides are conflicting
- Check for environment variables that might override appsettings.json

### Issue: "Entity Framework tools not found"

**Solution:**
Install EF Core tools globally:
```powershell
dotnet tool install --global dotnet-ef
```

Update existing installation:
```powershell
dotnet tool update --global dotnet-ef
```

### Issue: "Migration created but changes not reflected in database"

**Solution:**
1. Verify the migration file contains the expected changes
2. Check that `dotnet ef database update` was run successfully
3. Review the migration's `Up()` method to ensure it contains the expected SQL

---

## Best Practices

1. **Always test migrations on a development database first**
2. **Review generated migration files before applying**
3. **Use version control (Git) to track migration files**
4. **Keep connection strings out of source control for production values**
5. **Use environment variables or User Secrets for sensitive connection strings**
6. **Create database backups before applying migrations in production**
7. **Ensure API and Web projects use the same connection string**
8. **Use meaningful migration names that describe the change**

---

## Quick Reference Commands

```powershell
# Navigate to project root
cd "D:\My Archi\Core"

# Create migration
dotnet ef migrations add MigrationName -p src\CommonArchitecture.Infrastructure -s src\CommonArchitecture.Web

# Apply migrations
dotnet ef database update -p src\CommonArchitecture.Infrastructure -s src\CommonArchitecture.Web

# List pending migrations
dotnet ef migrations list -p src\CommonArchitecture.Infrastructure -s src\CommonArchitecture.Web

# Remove last migration (if not applied)
dotnet ef migrations remove -p src\CommonArchitecture.Infrastructure -s src\CommonArchitecture.Web

# Generate SQL script (without applying)
dotnet ef migrations script -p src\CommonArchitecture.Infrastructure -s src\CommonArchitecture.Web
```

---

## Additional Resources

- [Entity Framework Core Migrations Documentation](https://learn.microsoft.com/en-us/ef/core/managing-schemas/migrations/)
- [Connection Strings Reference](https://www.connectionstrings.com/sql-server/)
- [ASP.NET Core Configuration](https://learn.microsoft.com/en-us/aspnet/core/fundamentals/configuration/)

