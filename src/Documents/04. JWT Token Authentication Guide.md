# JWT Token Authentication - Complete Guide

This document provides a comprehensive explanation of how JWT (JSON Web Token) authentication works in the CommonArchitecture solution, including the complete flow from login to token refresh and logout.

---

## Table of Contents

1. [Overview](#overview)
2. [JWT Token Components](#jwt-token-components)
3. [Architecture Overview](#architecture-overview)
4. [Complete Authentication Flow](#complete-authentication-flow)
5. [Token Storage Mechanism](#token-storage-mechanism)
6. [Token Refresh Flow](#token-refresh-flow)
7. [API Request Flow](#api-request-flow)
8. [Security Features](#security-features)
9. [Configuration](#configuration)
10. [Troubleshooting](#troubleshooting)

---

## Overview

The application uses **JWT Bearer Token Authentication** with a **refresh token mechanism** for secure, stateless authentication. The system implements:

- **Access Tokens**: Short-lived (15 minutes) JWT tokens for API authorization
- **Refresh Tokens**: Long-lived (7 days) tokens stored in database for token renewal
- **HTTP-Only Cookies**: Secure storage of tokens in browser cookies (XSS protection)
- **Automatic Token Refresh**: Seamless token renewal when access token expires
- **Token Reuse Detection**: Security mechanism to detect token replay attacks

---

## JWT Token Components

### Access Token Structure

A JWT token consists of three parts separated by dots (`.`):

```
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c
```

**Parts:**
1. **Header** (Red): Algorithm and token type
2. **Payload** (Purple): Claims (user information)
3. **Signature** (Blue): Verification signature

### Decoded Access Token Example

**Header:**
```json
{
  "alg": "HS256",
  "typ": "JWT"
}
```

**Payload (Claims):**
```json
{
  "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier": "1",
  "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name": "John Doe",
  "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress": "john@example.com",
  "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/mobilephone": "9876543210",
  "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/role": "Admin",
  "RoleId": "1",
  "jti": "550e8400-e29b-41d4-a716-446655440000",
  "iss": "CommonArchitecture.API",
  "aud": "CommonArchitecture.Web",
  "exp": 1234567890,
  "iat": 1234567800
}
```

**Key Claims:**
- `nameidentifier`: User ID
- `name`: User's full name
- `emailaddress`: User's email
- `mobilephone`: User's mobile number
- `role`: User's role name
- `RoleId`: User's role ID
- `jti`: JWT ID (unique token identifier)
- `iss`: Issuer (CommonArchitecture.API)
- `aud`: Audience (CommonArchitecture.Web)
- `exp`: Expiration timestamp
- `iat`: Issued at timestamp

---

## Architecture Overview

### Components Involved

```
┌─────────────────────────────────────────────────────────────────┐
│                        CLIENT (Browser)                          │
│  - HTTP-Only Cookies (Access Token, Refresh Token)              │
│  - Session (User Info for UI)                                   │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            │ HTTP Requests
                            │
        ┌───────────────────┴───────────────────┐
        │                                       │
        ▼                                       ▼
┌──────────────────────┐              ┌──────────────────────┐
│   WEB PROJECT        │              │    API PROJECT       │
│                      │              │                      │
│ ┌──────────────────┐ │              │ ┌──────────────────┐ │
│ │ AuthController   │ │─────────────▶│ │ AuthController   │ │
│ │ (Login/Logout)   │ │              │ │ (JWT Generation) │ │
│ └──────────────────┘ │              │ └──────────────────┘ │
│                      │              │                      │
│ ┌──────────────────┐ │              │ ┌──────────────────┐ │
│ │ TokenStorage     │ │              │ │ JwtService       │ │
│ │ Service          │ │              │ │ (Token Gen/Val)  │ │
│ └──────────────────┘ │              │ └──────────────────┘ │
│                      │              │                      │
│ ┌──────────────────┐ │              │ ┌──────────────────┐ │
│ │ RefreshToken     │ │─────────────▶│ │ RefreshToken     │ │
│ │ Handler          │ │              │ │ Repository       │ │
│ │ (Auto Refresh)   │ │              │ │ (DB Operations)  │ │
│ └──────────────────┘ │              │ └──────────────────┘ │
│                      │              │                      │
│ ┌──────────────────┐ │              │ ┌──────────────────┐ │
│ │ ProductApiService│ │─────────────▶│ │ Products         │ │
│ │ UserApiService   │ │   + JWT      │ │ Controller       │ │
│ │ etc.             │ │   Header     │ │ (Protected)      │ │
│ └──────────────────┘ │              │ └──────────────────┘ │
└──────────────────────┘              └──────────────────────┘
                                              │
                                              │
                                              ▼
                                    ┌──────────────────────┐
                                    │   DATABASE           │
                                    │  - RefreshTokens     │
                                    │  - Users             │
                                    └──────────────────────┘
```

---

## Complete Authentication Flow

### Step 1: User Login

**1.1. User Enters Credentials**
```
User → Web UI → Enters Mobile Number
```

**1.2. Send OTP Request**
```
Web AuthController → AuthApiService → API /api/auth/send-otp
```

**1.3. Verify OTP and Login**
```
Web AuthController → AuthApiService → API /api/auth/login
```

**1.4. API Validates and Generates Tokens**
```
Location: src/CommonArchitecture.API/Controllers/AuthController.cs

[HttpPost("login")]
public async Task<ActionResult<LoginResponseDto>> Login([FromBody] LoginRequestDto request)
{
    // 1. Validate OTP
    if (request.Otp != FIXED_OTP) return Unauthorized();
    
    // 2. Get user from database
    var user = await _authRepository.GetUserByMobileAsync(request.Mobile);
    
    // 3. Generate Access Token
    var accessToken = _jwtService.GenerateAccessToken(user);
    
    // 4. Generate Refresh Token
    var refreshToken = _jwtService.GenerateRefreshToken();
    
    // 5. Save Refresh Token to Database
    var refreshTokenEntity = new RefreshToken
    {
        Token = refreshToken,
        UserId = user.Id,
        ExpiresAt = DateTime.UtcNow.AddDays(7),
        DeviceFingerprint = deviceFingerprint,
        IpAddress = ipAddress,
        UserAgent = userAgent
    };
    await _refreshTokenRepository.CreateAsync(refreshTokenEntity);
    
    // 6. Return tokens to client
    return Ok(new LoginResponseDto
    {
        AccessToken = accessToken,
        RefreshToken = refreshToken,
        ExpiresAt = DateTime.UtcNow.AddMinutes(15),
        User = userDto
    });
}
```

**1.5. Web Saves Tokens**
```
Location: src/CommonArchitecture.Web/Services/AuthApiService.cs

public async Task<LoginResponseDto> LoginAsync(LoginRequestDto request)
{
    var loginResponse = await _httpClient.PostAsync("/api/auth/login", content);
    
    // Save tokens to cookies and memory cache
    if (loginResponse.Success)
    {
        await _tokenStorageService.SaveTokensAsync(
            loginResponse.AccessToken,
            loginResponse.RefreshToken,
            loginResponse.ExpiresAt);
    }
    
    return loginResponse;
}
```

**1.6. Token Storage**
```
Location: src/CommonArchitecture.Web/Services/TokenStorageService.cs

public Task SaveTokensAsync(string accessToken, string refreshToken, DateTime expiresAt)
{
    // Save to HTTP-Only Cookies
    httpContext.Response.Cookies.Append("access_token", accessToken, cookieOptions);
    httpContext.Response.Cookies.Append("refresh_token", refreshToken, cookieOptions);
    
    // Save to Memory Cache (for background requests)
    _memoryCache.Set("cached_access_token", accessToken, expiresAt);
    _memoryCache.Set("cached_refresh_token", refreshToken, DateTime.UtcNow.AddDays(7));
}
```

**1.7. Store User Info in Session**
```
Location: src/CommonArchitecture.Web/Areas/Admin/Controllers/AuthController.cs

[HttpPost]
public async Task<IActionResult> Login([FromBody] LoginRequestDto request)
{
    var result = await _authApiService.LoginAsync(request);
    
    if (result.Success && result.User != null)
    {
        // Store user info in session (for UI display)
        HttpContext.Session.SetString("UserId", result.User.Id.ToString());
        HttpContext.Session.SetString("UserName", result.User.Name);
        HttpContext.Session.SetString("UserEmail", result.User.Email);
        HttpContext.Session.SetString("UserRoleId", result.User.RoleId.ToString());
        HttpContext.Session.SetString("UserRoleName", result.User.RoleName);
    }
    
    return Json(result);
}
```

**Complete Login Flow Diagram:**
```
┌─────────┐    1. Enter Mobile     ┌──────────┐
│  User   │────────────────────────▶│   Web    │
│         │                         │    UI    │
└─────────┘                         └────┬─────┘
                                         │ 2. Send OTP
                                         ▼
                                    ┌──────────┐
                                    │   Web    │
                                    │  Auth    │
                                    │Controller│
                                    └────┬─────┘
                                         │ 3. POST /api/auth/send-otp
                                         ▼
                                    ┌──────────┐
                                    │   API    │
                                    │  Auth    │
                                    │Controller│
                                    └────┬─────┘
                                         │ 4. Validate & Generate Tokens
                                         │    - Access Token (JWT)
                                         │    - Refresh Token (Random)
                                         ▼
                                    ┌──────────┐
                                    │   API    │
                                    │  Jwt     │
                                    │ Service  │
                                    └────┬─────┘
                                         │ 5. Save Refresh Token
                                         ▼
                                    ┌──────────┐
                                    │Database  │
                                    │Refresh   │
                                    │Tokens    │
                                    └──────────┘
                                         │
                                         │ 6. Return Tokens
                                         ▼
                                    ┌──────────┐    7. Save to Cookies
                                    │   Web    │◀─────────────────────┐
                                    │  Auth    │                      │
                                    │  API     │                      │
                                    │ Service  │                      │
                                    └────┬─────┘                      │
                                         │ 8. Store in Session        │
                                         ▼                            │
                                    ┌──────────┐                      │
                                    │   Web    │                      │
                                    │  Auth    │                      │
                                    │Controller│                      │
                                    └────┬─────┘                      │
                                         │ 9. Save to Cookies         │
                                         ▼                            │
                                    ┌──────────┐                      │
                                    │ Token    │──────────────────────┘
                                    │ Storage  │
                                    │ Service  │
                                    └──────────┘
                                    Cookies: access_token, refresh_token
                                    Session: UserId, UserName, etc.
```

---

## Token Storage Mechanism

### Storage Locations

**1. HTTP-Only Cookies** (Primary Storage)
- **Purpose**: Secure browser storage, protected from XSS attacks
- **Cookies**:
  - `access_token`: Access token (expires in 15 minutes)
  - `refresh_token`: Refresh token (expires in 7 days)
  - `token_expires`: Expiration timestamp
- **Security Settings**:
  ```csharp
  HttpOnly = true,        // JavaScript cannot access
  Secure = true,          // HTTPS only (production)
  SameSite = Strict,      // CSRF protection
  IsEssential = true      // Required for functionality
  ```

**2. Memory Cache** (Fallback Storage)
- **Purpose**: Available for background HTTP requests without HTTP context
- **Cache Keys**:
  - `cached_access_token`
  - `cached_refresh_token`
  - `cached_token_expires`

**3. Session Storage** (User Info Only)
- **Purpose**: Store user display information (name, email, role) for UI
- **Not Used**: For API authentication (only for UI display)

**4. Database** (Refresh Tokens Only)
- **Purpose**: Store refresh tokens for validation and revocation
- **Table**: `RefreshTokens`
- **Fields**: Token, UserId, ExpiresAt, IsRevoked, DeviceFingerprint, IpAddress, UserAgent, PreviousToken

### Token Retrieval Priority

When retrieving tokens, the system uses this priority:

```
1. Check HTTP Context Cookies (user request)
   ↓ (if not found)
2. Check Memory Cache (background request)
   ↓ (if not found)
3. Return null (no token available)
```

---

## Token Refresh Flow

### When Token Refresh Occurs

1. **Automatic**: Before API request if access token is expired
2. **On 401 Response**: If API returns Unauthorized status
3. **Proactive**: Check expiration before each API call

### Refresh Token Flow

**Step 1: Detect Token Expiration**
```
Location: src/CommonArchitecture.Web/Handlers/RefreshTokenHandler.cs

protected override async Task<HttpResponseMessage> SendAsync(...)
{
    // Attach current access token
    var accessToken = await tokenStorageService.GetAccessTokenAsync();
    request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", accessToken);
    
    // Send request
    var response = await base.SendAsync(request, cancellationToken);
    
    // If 401, token might be expired
    if (response.StatusCode == HttpStatusCode.Unauthorized)
    {
        // Trigger refresh flow
    }
}
```

**Step 2: Call Refresh Token API**
```
Location: src/CommonArchitecture.Web/Handlers/RefreshTokenHandler.cs

// Get refresh token
var refreshToken = await tokenStorageService.GetRefreshTokenAsync();

// Call API to refresh
var refreshResp = await authApiService.RefreshTokenAsync(
    new RefreshTokenRequestDto { RefreshToken = refreshToken });
```

**Step 3: API Validates Refresh Token**
```
Location: src/CommonArchitecture.API/Controllers/AuthController.cs

[HttpPost("refresh-token")]
public async Task<ActionResult<RefreshTokenResponseDto>> RefreshToken([FromBody] RefreshTokenRequestDto request)
{
    // 1. Get refresh token from database
    var refreshTokenEntity = await _refreshTokenRepository.GetByTokenAsync(request.RefreshToken);
    
    // 2. Validate token
    if (refreshTokenEntity == null || 
        refreshTokenEntity.IsRevoked || 
        refreshTokenEntity.ExpiresAt < DateTime.UtcNow)
    {
        return Unauthorized("Invalid or expired refresh token");
    }
    
    // 3. Check for token reuse (security)
    if (await _refreshTokenRepository.IsTokenReusedAsync(request.RefreshToken, refreshTokenEntity.UserId))
    {
        // Revoke all user tokens (security measure)
        await _refreshTokenRepository.RevokeAllUserTokensAsync(refreshTokenEntity.UserId);
        return Unauthorized("Token reuse detected");
    }
    
    // 4. Revoke old refresh token
    await _refreshTokenRepository.RevokeTokenAsync(request.RefreshToken);
    
    // 5. Generate new tokens
    var accessToken = _jwtService.GenerateAccessToken(user);
    var newRefreshToken = _jwtService.GenerateRefreshToken();
    
    // 6. Save new refresh token (with old token as PreviousToken for reuse detection)
    var newRefreshTokenEntity = new RefreshToken
    {
        Token = newRefreshToken,
        UserId = user.Id,
        PreviousToken = request.RefreshToken, // For reuse detection
        ExpiresAt = DateTime.UtcNow.AddDays(7)
    };
    await _refreshTokenRepository.CreateAsync(newRefreshTokenEntity);
    
    // 7. Return new tokens
    return Ok(new RefreshTokenResponseDto
    {
        AccessToken = accessToken,
        RefreshToken = newRefreshToken,
        ExpiresAt = DateTime.UtcNow.AddMinutes(15)
    });
}
```

**Step 4: Save New Tokens**
```
Location: src/CommonArchitecture.Web/Handlers/RefreshTokenHandler.cs

// Save new tokens
await tokenStorageService.SaveTokensAsync(
    refreshResp.AccessToken,
    refreshResp.RefreshToken,
    refreshResp.ExpiresAt);

// Retry original request with new token
var retry = CloneRequest(request, contentBytes);
retry.Headers.Authorization = new AuthenticationHeaderValue("Bearer", refreshResp.AccessToken);
var finalResp = await base.SendAsync(retry, cancellationToken);
return finalResp;
```

**Token Refresh Flow Diagram:**
```
┌──────────┐    1. API Request    ┌──────────┐
│   Web    │──────────────────────▶│ Refresh  │
│ Service  │   (Expired Token)    │ Token    │
│          │                       │ Handler  │
└──────────┘                       └────┬─────┘
                                        │ 2. Get Refresh Token
                                        ▼
                                   ┌──────────┐
                                   │ Token    │
                                   │ Storage  │
                                   │ Service  │
                                   └────┬─────┘
                                        │ 3. POST /api/auth/refresh-token
                                        ▼
                                   ┌──────────┐
                                   │   API    │
                                   │  Auth    │
                                   │Controller│
                                   └────┬─────┘
                                        │ 4. Validate Refresh Token
                                        ▼
                                   ┌──────────┐
                                   │Refresh   │
                                   │Token     │
                                   │Repository│
                                   └────┬─────┘
                                        │ 5. Revoke Old Token
                                        │    Generate New Tokens
                                        ▼
                                   ┌──────────┐
                                   │   API    │
                                   │  Jwt     │
                                   │ Service  │
                                   └────┬─────┘
                                        │ 6. Save New Refresh Token
                                        ▼
                                   ┌──────────┐
                                   │Database  │
                                   │Refresh   │
                                   │Tokens    │
                                   └────┬─────┘
                                        │ 7. Return New Tokens
                                        ▼
                                   ┌──────────┐    8. Save New Tokens
                                   │ Refresh  │◀──────────────────┐
                                   │ Token    │                   │
                                   │ Handler  │                   │
                                   └────┬─────┘                   │
                                        │ 9. Retry Original       │
                                        │    Request              │
                                        ▼                         │
                                   ┌──────────┐                   │
                                   │   API    │                   │
                                   │Controller│                   │
                                   └──────────┘                   │
                                                                  │
                                        ┌─────────────────────────┘
                                        │ 10. Save to Cookies & Cache
                                        ▼
                                   ┌──────────┐
                                   │ Token    │
                                   │ Storage  │
                                   │ Service  │
                                   └──────────┘
```

---

## API Request Flow

### How API Requests Include JWT Tokens

**Step 1: Web Service Makes API Call**
```
Location: src/CommonArchitecture.Web/Services/ProductApiService.cs

public async Task<PaginatedResult<ProductDto>> GetAllAsync(...)
{
    // HttpClient is configured with RefreshTokenHandler
    var result = await _httpClient.GetFromJsonAsync<PaginatedResult<ProductDto>>("api/products");
    return result;
}
```

**Step 2: RefreshTokenHandler Intercepts Request**
```
Location: src/CommonArchitecture.Web/Handlers/RefreshTokenHandler.cs

protected override async Task<HttpResponseMessage> SendAsync(...)
{
    // 1. Get access token from storage
    var accessToken = await tokenStorageService.GetAccessTokenAsync();
    
    // 2. Attach token to request header
    request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", accessToken);
    
    // 3. Send request
    var response = await base.SendAsync(request, cancellationToken);
    
    // 4. If 401, refresh token and retry
    if (response.StatusCode == HttpStatusCode.Unauthorized)
    {
        // Refresh flow (as described above)
    }
    
    return response;
}
```

**Step 3: API Validates Token**
```
Location: src/CommonArchitecture.API/Program.cs

builder.Services.AddAuthentication(options =>
{
    options.DefaultAuthenticateScheme = JwtBearerDefaults.AuthenticationScheme;
    options.DefaultChallengeScheme = JwtBearerDefaults.AuthenticationScheme;
})
.AddJwtBearer(options =>
{
    options.TokenValidationParameters = new TokenValidationParameters
    {
        ValidateIssuer = true,              // Check issuer
        ValidateAudience = true,            // Check audience
        ValidateLifetime = true,            // Check expiration
        ValidateIssuerSigningKey = true,    // Validate signature
        ValidIssuer = issuer,               // "CommonArchitecture.API"
        ValidAudience = audience,           // "CommonArchitecture.Web"
        IssuerSigningKey = new SymmetricSecurityKey(Encoding.UTF8.GetBytes(secretKey)),
        ClockSkew = TimeSpan.Zero          // No clock skew tolerance
    };
});
```

**Step 4: Controller Uses [Authorize] Attribute**
```
Location: src/CommonArchitecture.API/Controllers/ProductsController.cs

[HttpPost]
[Authorize]  // Requires valid JWT token
public async Task<ActionResult<ProductDto>> Create(CreateProductDto createDto)
{
    // User is authenticated, access token validated
    // Can access User.Claims for user information
    var userId = User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
    
    var command = new CreateProductCommand(...);
    var product = await _mediator.Send(command);
    return CreatedAtAction(nameof(GetById), new { id = product.Id }, product);
}
```

**Complete API Request Flow:**
```
┌──────────┐    1. GetAllAsync()    ┌──────────┐
│   Web    │────────────────────────▶│Product   │
│Controller│                         │Api       │
│          │                         │Service   │
└──────────┘                         └────┬─────┘
                                          │ 2. HttpClient.GetAsync()
                                          ▼
                                   ┌──────────┐
                                   │ Refresh  │
                                   │ Token    │
                                   │ Handler  │
                                   └────┬─────┘
                                        │ 3. Get Access Token
                                        ▼
                                   ┌──────────┐
                                   │ Token    │
                                   │ Storage  │
                                   │ Service  │
                                   └────┬─────┘
                                        │ 4. Add Authorization Header
                                        │    Authorization: Bearer {token}
                                        ▼
                                   ┌──────────┐    5. HTTP Request
                                   │   API    │◀─────────────────
                                   │Products  │    GET /api/products
                                   │Controller│    Authorization: Bearer {token}
                                   └────┬─────┘
                                        │ 6. JWT Authentication Middleware
                                        │    - Validate signature
                                        │    - Check expiration
                                        │    - Verify issuer/audience
                                        │    - Extract claims
                                        ▼
                                   ┌──────────┐
                                   │ JWT      │
                                   │ Bearer   │
                                   │ Middleware│
                                   └────┬─────┘
                                        │ 7. If valid, set User.Claims
                                        │    If invalid, return 401
                                        ▼
                                   ┌──────────┐
                                   │Products  │
                                   │Controller│
                                   │ [Authorize]
                                   └────┬─────┘
                                        │ 8. Execute action
                                        ▼
                                   ┌──────────┐    9. Return Response
                                   │Product   │───────────────────▶
                                   │Repository│
                                   └──────────┘
```

---

## Security Features

### 1. HTTP-Only Cookies
- **Protection**: Prevents XSS attacks from stealing tokens
- **Implementation**: Cookies are not accessible via JavaScript
- **Code**: `HttpOnly = true` in CookieOptions

### 2. Token Expiration
- **Access Token**: 15 minutes (short-lived, reduces risk if compromised)
- **Refresh Token**: 7 days (long-lived for better UX)
- **Automatic Refresh**: Transparent to user

### 3. Token Reuse Detection
- **Purpose**: Detect if a refresh token is used multiple times (potential attack)
- **Mechanism**: Store previous token in `PreviousToken` field
- **Action**: If reuse detected, revoke all user tokens

```csharp
// Check if token was previously used
if (await _refreshTokenRepository.IsTokenReusedAsync(refreshToken, userId))
{
    // Security breach detected - revoke all tokens
    await _refreshTokenRepository.RevokeAllUserTokensAsync(userId);
    return Unauthorized("Token reuse detected");
}
```

### 4. Device Fingerprinting
- **Purpose**: Track devices for security monitoring
- **Stored**: DeviceFingerprint, IpAddress, UserAgent with each refresh token
- **Use**: Detect suspicious login patterns

### 5. Token Revocation
- **On Logout**: Revoke all user tokens
- **On Token Reuse**: Revoke all user tokens (security breach)
- **Database Storage**: Refresh tokens stored with `IsRevoked` flag

### 6. Rate Limiting
- **Endpoint**: `/api/auth/login`, `/api/auth/refresh-token`
- **Limit**: 5 requests per minute per IP address
- **Purpose**: Prevent brute force attacks

```csharp
builder.Services.AddRateLimiter(options =>
{
    options.AddPolicy("AuthPolicy", context =>
        RateLimitPartition.GetFixedWindowLimiter(
            partitionKey: context.Connection.RemoteIpAddress?.ToString(),
            factory: partition => new FixedWindowRateLimiterOptions
            {
                PermitLimit = 5,        // 5 requests
                Window = TimeSpan.FromMinutes(1)  // per minute
            }));
});
```

### 7. Secure Cookie Settings
- **SameSite**: `Strict` (CSRF protection)
- **Secure**: `true` in production (HTTPS only)
- **HttpOnly**: `true` (XSS protection)

### 8. JWT Signature Validation
- **Algorithm**: HMAC-SHA256
- **Key**: Stored securely (User Secrets / Environment Variables)
- **Validation**: Signature verified on every request

---

## Configuration

### JWT Settings (appsettings.json)

**API Project:**
```json
{
  "Jwt": {
    "SecretKey": "NOT_SET_IN_APPsettings_USE_USER_SECRETS_OR_ENV_VARS",
    "Issuer": "CommonArchitecture.API",
    "Audience": "CommonArchitecture.Web",
    "AccessTokenExpirationMinutes": "15",
    "RefreshTokenExpirationDays": "7"
  }
}
```

### Setting JWT Secret Key

**Development (User Secrets):**
```powershell
cd src/CommonArchitecture.API
dotnet user-secrets init
dotnet user-secrets set "Jwt:SecretKey" "YourSuperSecretKeyThatIsAtLeast32CharactersLongForHS256Algorithm!"
```

**Production (Environment Variables):**
```powershell
# Windows
$env:Jwt__SecretKey="YourSuperSecretKeyThatIsAtLeast32CharactersLongForHS256Algorithm!"

# Linux/macOS
export Jwt__SecretKey="YourSuperSecretKeyThatIsAtLeast32CharactersLongForHS256Algorithm!"
```

**Important**: Secret key must be at least 32 characters for HS256 algorithm.

### API Base URL (Web Project)

**appsettings.json:**
```json
{
  "ApiSettings": {
    "BaseUrl": "http://localhost:5089"
  }
}
```

### CORS Configuration (API Project)

```csharp
builder.Services.AddCors(options =>
{
    options.AddPolicy("WebPolicy", policy =>
    {
        policy.WithOrigins("https://localhost:7001", "http://localhost:5000")
              .AllowAnyMethod()
              .AllowAnyHeader()
              .AllowCredentials();  // Required for cookies
    });
});
```

---

## Troubleshooting

### Issue: "JWT SecretKey not configured"

**Solution:**
1. Set JWT secret key in User Secrets (development) or Environment Variables (production)
2. Ensure key is at least 32 characters long
3. Restart the application

### Issue: "401 Unauthorized" on API calls

**Possible Causes:**
1. Token expired - Check if automatic refresh is working
2. Invalid token - Clear cookies and login again
3. CORS issues - Check CORS configuration
4. Token not being sent - Check RefreshTokenHandler is registered

**Solution:**
1. Check browser cookies (access_token should exist)
2. Check token expiration time
3. Verify RefreshTokenHandler is registered in Program.cs
4. Check API logs for authentication errors

### Issue: Token refresh not working

**Possible Causes:**
1. Refresh token expired or revoked
2. RefreshTokenHandler not intercepting requests
3. Token storage service not saving tokens

**Solution:**
1. Check database for refresh token (RefreshTokens table)
2. Verify RefreshTokenHandler is added to HttpClient pipeline
3. Check TokenStorageService logs
4. Clear cookies and login again to get new refresh token

### Issue: Cookies not being set

**Possible Causes:**
1. CORS configuration missing `AllowCredentials`
2. Cookie settings too restrictive
3. HTTPS required but using HTTP

**Solution:**
1. Check CORS configuration includes `AllowCredentials()`
2. Verify cookie settings (SameSite, Secure)
3. Use HTTPS or set `Secure = false` for development

### Issue: "Token reuse detected" error

**Explanation**: This is a security feature. If the same refresh token is used twice, all user tokens are revoked.

**Solution:**
1. This is expected behavior for security
2. User must login again
3. Check if refresh token logic is being called multiple times simultaneously

### Issue: Session not persisting after login

**Note**: Session stores user info for UI display. JWT tokens are separate and stored in cookies.

**Solution:**
1. Verify Session middleware is configured in Program.cs
2. Check session cookie settings
3. Ensure `UseSession()` is called before `UseAuthorization()`

---

## Key Files Reference

### Core Components

1. **JWT Service**: `src/CommonArchitecture.Application/Services/JwtService.cs`
   - Generates access tokens
   - Generates refresh tokens
   - Validates expired tokens

2. **Token Storage**: `src/CommonArchitecture.Web/Services/TokenStorageService.cs`
   - Saves/retrieves tokens from cookies and cache
   - Checks token expiration

3. **Refresh Token Handler**: `src/CommonArchitecture.Web/Handlers/RefreshTokenHandler.cs`
   - Intercepts HTTP requests
   - Adds JWT token to headers
   - Automatically refreshes expired tokens

4. **Auth Controller (API)**: `src/CommonArchitecture.API/Controllers/AuthController.cs`
   - Login endpoint
   - Refresh token endpoint
   - Logout endpoint

5. **Auth Controller (Web)**: `src/CommonArchitecture.Web/Areas/Admin/Controllers/AuthController.cs`
   - Login UI
   - Session management
   - Logout UI

6. **Refresh Token Repository**: `src/CommonArchitecture.Infrastructure/Repositories/RefreshTokenRepository.cs`
   - Database operations for refresh tokens
   - Token validation and revocation

---

## Summary

The JWT authentication system in CommonArchitecture provides:

✅ **Secure Token Storage**: HTTP-Only cookies protect against XSS  
✅ **Automatic Token Refresh**: Seamless token renewal  
✅ **Token Reuse Detection**: Security against replay attacks  
✅ **Device Tracking**: Monitor login patterns  
✅ **Rate Limiting**: Protection against brute force  
✅ **Stateless Authentication**: Scalable JWT-based auth  
✅ **Session Integration**: User info in session for UI  

This architecture ensures secure, user-friendly authentication while maintaining best security practices.

